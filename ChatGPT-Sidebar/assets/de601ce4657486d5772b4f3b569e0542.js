import{H as i,V as a,c as O}from"./e9f75e36460fce00961861b26033c5f6.js";import"./72fd4ee2d5a3adb51faedc97ae5209b5.js";import"./397df68e72150072960998f20fc4b12d.js";import"./3178c8329fb7343c4a8df5c5d4b8f2f2.js";import"./86e8490f22d5ffaff40ca5879db6ec11.js";import"./e89f80fef20b267b41c7f233de7c44bc.js";import"./6af5ed63a73223aaf36e83f20fa1f6ae.js";import"./857d445419d45c89a951acec196a4c6c.js";import"./658cf16f1475fd823ea3f6b38f5982b1.js";import"./e17dd21e954285ab8e57edc5aaa8d095.js";import"./7178c4095b3167bc462b8cb724642193.js";import"./e8fce94663e5d679d1f5600ec59f654e.js";import"./4f72198a2c56625f6e2ce33df598b892.js";import"./12505fbd7c357225cfee202a261ae734.js";import"./20f06371b524a2c3b5ac6431576be3ce.js";import"./0c2332fe3748cc1a7d9e75130754fe1a.js";import"./843996722d01d8c64a3babfbb75a2562.js";import"./bc30000a11905b644c9c532ed7a81acc.js";let M;function L(e){M=e,M.postMessage({greeting:"hi there content script!"}),M.onMessage.addListener((e=>{console.log("In background script, received message from content script"),console.log(e.greeting)}))}if(i.Browser().runtime.onMessage.addListener(((e,t,a)=>i.sendMessageListener(e,t,a))),i.Browser().runtime.onMessageExternal.addListener(((e,t,a)=>i.sendMessageListener(e,t,a,!0))),i.Browser().runtime.onConnect.addListener(L),typeof ScrappingInit>"u"){let e=function(e){if(typeof e.wait_time<"u"&&(E=e.wait_time),typeof e.restart_time<"u"&&(p=e.restart_time),typeof e.app_status<"u"&&(k=e.app_status),typeof e.collections<"u"){h=e.collections;let r=0;return a.debugMode&&console.log(h),h.forEach(((a,o)=>{if(0==r&&typeof a<"u")return r=1,a=t(a,e),ScrapCall(a),h.splice(o,1),e.collections=h,e})),e}{let a=t(e,e);ScrapCall(a)}function t(e,t){if(!(typeof e.type>"u"&&typeof t.collection>"u"))return typeof e.market_place_id>"u"&&typeof e.marketplace_id<"u"&&(e.market_place_id=e.marketplace_id),typeof t.collection<"u"&&typeof e.market_place_id>"u"&&typeof t.collection.market_place_id<"u"&&(e.market_place_id=t.collection.market_place_id),typeof e.url>"u"?(e.origin=a.marketplace_idBydomain[e.market_place_id],e.url=e.origin+e.uri):e.url||(e.origin=a.marketplace_idBydomain[e.market_place_id],e.url=e.origin+e.uri),typeof e.market_place_id<"u"&&(e.base_url=a.marketplace_idBydomain[e.market_place_id]),typeof t.app_status>"u"&&(t.app_status=k),1!=t.app_status?void setTimeout((()=>{this.ScarpingEnd()}),2*p):e}return item};var C=0,E=4e3,p=4e4,k=1,v=1,x=Date.now(),h=[];globalThis.ScrapCollection=()=>{let t=((Math.random()+1)*E).toFixed(0);i.Browser().storage.local.get("start_scrap").then((function(r){typeof r.start_scrap>"u"&&(r.start_scrap=0),1!==(C=r.start_scrap)?(a.debugMode&&console.log("Starting",t,"scrapCout: "+v,(new Date).toISOString().replaceAll(/-/g,"_")),C=1,i.Browser().storage.local.set({start_scrap:1}).then((()=>{if(Object.keys(h).length>0)return e({collections:h});i.fetchWithTimeout(a.api_url+"/extensions/scraping/get?"+(new Date).toISOString().replaceAll(/-/g,"_"),{method:"POST",headers:{"Content-type":"application/json"},body:JSON.stringify({merchants:Object.keys(a.merchants??{})})},3e4).then((e=>e.text()??e)).then((t=>{let a=JSON.parse(t);if("success"==a.status)return a=a.data,e(a);setTimeout((()=>{ScarpingEnd()}),2*p)})).catch((e=>{a.debugMode&&console.log(e)}))}))):a.debugMode&&console.log("Running",t)}))},globalThis.ScrapCall=(e,t=null)=>{t||(t=a.api_url),x=Date.now();let r=new Headers;return r.append("Access-Control-Allow-Origin",e.origin),fetch(e.url,{mode:"same-origin",headers:r,redirect:"manual"}).then((function(t){return e.header={},t.headers.forEach(((t,a)=>{e.header[a]=t})),e.header.status_text=t.statusText,e.header.status_code=t.status,a.debugMode&&console.log(e),!t.redirected&&200===t.status&&t.text()})).then((r=>{if(a.debugMode&&console.log(r.toString().length,r.toString().indexOf("Type the characters you see")),r&&-1!==r.toString().indexOf("Type the characters you see"))return globalThis.ScarpingEnd(),setTimeout(ScrapCollection,2*p),r;let o=null;if("application/json"==e.type){let a=new AbortController;setTimeout((e=>{a.abort(),i.Browser().runtime.sendMessage(i.Browser().runtime.id,{fn:"ScarpingEnd",data:null},(e=>e))}),5e4),e.data=r,e.header=r,fetch(t+"/extensions/scraping/set?time="+(new Date).toISOString().replaceAll(/-/g,"_"),{method:"POST",body:JSON.stringify(e),signal:a.signal})}else i.Browser().tabs.query({status:"complete"}).then((t=>{if(!t)return ScrapCall(e);t.forEach((e=>{!o&&-1!==e.url.indexOf("https://")&&-1===e.url.indexOf("webstore")&&(o=e)})),typeof o.id>"u"?setTimeout((()=>{globalThis.ScrapCall(e)}),2*p):i.Browser().scripting.executeScript({target:{tabId:o.id},function:Scraping,args:[r,e.type,e.elements,e,a.api_url,e.header,0,i.Browser()]}).then((e=>e)).catch((e=>{a.debugMode&&console.log(e,"Catch:161")}))})).catch((e=>{a.debugMode&&console.log(e,"Catch:168")}))})).catch((e=>{a.debugMode&&console.log(e,"Catch:174")}))},globalThis.Scraping=(e,t,r,o={},n=null,s=[],l=0,c=null)=>{null==c&&typeof i.Browser()<"u"&&(c=i.Browser()??null),typeof c.runtime>"u"&&typeof chrome<"u"&&(c=chrome),typeof c.runtime<"u"&&typeof c.runtime.sendMessage>"u"&&typeof chrome<"u"&&(c=chrome),null==n&&(n=a.api_url??null);let d=(new DOMParser).parseFromString(e,t),u="";if(r){r.forEach((function(e){d.querySelectorAll(e).forEach((function(e){u+=e.outerHTML}))})),o.data=u,o.header=s;let i=new AbortController,p=setTimeout((e=>{i.abort(),c.runtime.sendMessage(c.runtime.id,{fn:"ScarpingEnd",data:null},(e=>e))}),5e4);return fetch(n+"/extensions/scraping/set?time="+(new Date).toISOString().replaceAll(/-/g,"_"),{method:"POST",body:JSON.stringify(o),signal:i.signal}).then((e=>e.text())).then((e=>{if(e=JSON.parse(e),(new Date).toISOString().replaceAll(/-/g,"_"),typeof e.data<"u"&&typeof e.data.collection_type<"u"&&"success"===e.status){let t=e.data.wait_time??8e3,a=((Math.random()+1)*(t/2)).toFixed(0);return clearTimeout(p),p=null,setTimeout((()=>{c.runtime.sendMessage(c.runtime.id,{fn:"ScrapCall",data:e.data,api_url:n},(e=>e))}),a),e}c.runtime.sendMessage(c.runtime.id,{fn:"ScarpingEnd",data:null},(e=>e)),p&&clearTimeout(p)})).catch((n=>{if(i.abort(),p&&clearTimeout(p),l<2)return l++,console.log(n,"Catch"),setTimeout((i=>{globalThis.Scraping(e,t,r,o,a.api_url,s,l,c),clearTimeout(i)}),5e4),!1;c.runtime.sendMessage,setTimeout((()=>{c.runtime.sendMessage(c.runtime.id,{fn:"ScarpingEnd",data:null},(e=>e))}),6e4)})),!1}},globalThis.ScarpingEnd=()=>{a.debugMode&&console.log("Finish",p),v++,setTimeout((()=>{i.Browser().storage.local.set({start_scrap:0}).then((()=>{ScrapCollection()}))}),p)},globalThis.ScrapingCheck=()=>{if(0==k)return;let e=((Date.now()-x)/600).toFixed(0),t=(10*p/1e3).toFixed(0);a.debugMode&&console.log("ScrapingChack",e,t,Date.now(),x),e>t&&(ScarpingEnd(),ScrapCollection())},globalThis.ScrappingInit=()=>{i.setKey().then(),ScrapCollection()},ScrappingInit()}let B=!1;var A=e=>{{let t=!1;"install"==e.reason&&(t=!0),i.clearStorage(t),i.Browser().tabs.query({url:O.extension_dir+"src/html/setup.html"}).then((e=>{e.forEach((e=>{console.log(e),i.Browser().tabs.remove(e.id)}))}))}B||(B=!0,i.settingsBuild(!0).then((t=>{if("update"==e.reason&&i.notUndefined(t,"settings.search_ask_mode")){let e=t.settings;i.Browser().storage.local.set({settings:e})}"install"==e.reason&&i.openPage({url:O.extension_dir+"src/html/setup.html"})})))};i.Browser().runtime.onInstalled.addListener((async e=>A(e))),i.Browser().runtime.onUpdateAvailable.addListener((e=>A(e))),i.Browser().runtime.setUninstallURL(O.site+"/uninstall"),i.Browser().storage.local.set({migrate_test:1}),i.Browser().storage.local.get("uuid_hopekey").then((e=>{if(null==e.uuid_hopekey)return i.uuid(1)})),i.Browser().action.onClicked.addListener((e=>{i.Browser().sidePanel.setPanelBehavior({openPanelOnActionClick:!0}).catch((e=>console.error(e))),i.Browser().sidePanel.setOptions({enabled:!0})})),i.Browser().runtime.onMessage.addListener((e=>{if("action.onCaptureScreen"==e.fn){const{data:t}=e.data,{x:a,y:r,width:o,height:n,windowWidth:s}=t;if(!o||!n)return;i.captureCurrentViewport().then((e=>{fetch(e).then((e=>e.blob())).then((e=>{createImageBitmap(e).then((e=>{const t=e.width/s,l=a*t,c=r*t,d=o*t,u=n*t,p=new OffscreenCanvas(d,u);p.getContext("2d").drawImage(e,l,c,d,u,0,0,d,u),p.convertToBlob().then((e=>{const t=new FileReader;t.readAsDataURL(e),t.onloadend=()=>{const e=t.result;i.Browser().storage.local.set({ai_image_url:e}).then()}}))}))}))})).catch((e=>console.error(e)))}}));